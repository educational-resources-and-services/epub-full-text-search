<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>express service</title>
    <link href="main.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet prefetch"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
        const host = window.location.origin;
        var bootstrapAlert = function() {}
        bootstrapAlert.error = function(message) {
            $('#alert_placeholder').html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><span>'+message+'</span></div>')
        }
        function search() {

            $("#hits").empty();
            $('#search').button('loading');

            const term = $("#searchbox").val();

            if(term === "") {
                bootstrapAlert.error("Add search term ;-)");
                $('#search').button('reset');
                return;
            }


            const request = host + '/search?q=' + $("#searchbox").val();// + '&t=' + epubTitle;
            $.getJSON(request, '', {})
                .done((hits) => {

                    $('#search').button('reset');

                    if (hits.length > 0) {
//                        console.log("found " + hits.length + ' hits');

                        $('#hitsCount').text(hits.length + "." + ' hits');
                        for (var index in hits)
                            $("#hits").append($("<li class='list-group-item'>").html((++index) + ". <pre>" + syntaxHighlight(JSON.stringify(hits[index], undefined, 2)) + "</pre>"));

                    } else {

                        $("#hits").append($("<li>").html("<li class='list-group-item'>No Hits </li>"));
                    }
                    console.debug("search request ready");
                })
                .fail((d, textStatus, error) => {

                    $('#search').button('reset');
                    const err = d.status + " " + error + " -> message: " + d.responseText;
                    bootstrapAlert.error(err);
                    console.error(`Search request failed: \n ${err}`);
                });
        }

        // looking for suggestions
        function instantSearch() {

            const q = $("#searchbox").val();
            if (q === '')
                return;

            const matcher = "/matcher?beginsWith=" + q;
            const request = host + matcher;

            console.debug(request);

            $.getJSON(request, '', {})
                .done((data) => {

                    $("#searchbox").autocomplete({
                        source: data,
                        select: (event) => {
                            event.stopPropagation();
                            $("#search").trigger("click");
                        }
                    });
                })
                .fail((d, textStatus, error) => {

                    const err = d.status + " " + error + " -> message: " + d.responseText;
                    bootstrapAlert.error(err);
                    console.error(`Search request failed: \n ${err}`);
                });
        }


        function addEventHandler() {

            $("#search").click(search);
            $("#searchbox").keyup((event) => {

                if (event.which === 13)
                    return;

                instantSearch();
                event.stopPropagation();
            });
        }
        window.onload = addEventHandler;

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                var cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</head>
<body>
<div class="container theme-showcase" role="main">

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">

        <h1>Epub Search</h1>

        <h3>Sample books:</h3>
        <ul>
            <li>Accessible EPUB 3</li>
            <li>A First Course in Linear Algebra</li>
        </ul>
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">E.g. search for math, epub, someone, ...</h3>
            </div>
            <div class="panel-body">
                <form class="form-search form-inline">
                    <div class="input-group">
                        <input type="text" id="searchbox" name="searchbox" class="form-control search-query"
                               placeholder="Search" data-provide="typeahead"/>
                        <span class="input-group-btn">
                               <button id="search"
                                       type="button"
                                       class="btn btn-primary"
                                       data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> Processing">Search</button>
                           </span>
                    </div>
                </form>

            </div>
        </div>
        <div id = "alert_placeholder"></div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 id="hitsCount" class="panel-title">Hits</h3>
            </div>
            <div id="hits" class="list-group">
            </div>
        </div>
    </div>
</div>
</body>
</html>